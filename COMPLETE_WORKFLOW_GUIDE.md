# Complete Insurance Portal Workflow Guide

## ğŸ¯ Full Workflow Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    1. AGENCY SUBMISSION                      â”‚
â”‚  Agency â†’ Select Carrier â†’ Fill Form â†’ Submit               â”‚
â”‚                 â†“ Mock Email to Carrier                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               2. ADMIN ENTERS QUOTE (Status: ENTERED)        â”‚
â”‚  Admin â†’ View Submission â†’ Enter Quote â†’ Redirects to...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           3. ADMIN POSTS QUOTE (Status: POSTED)              â”‚
â”‚  Post Quote Page â†’ Add Carrier Reference â†’ Post Quote       â”‚
â”‚              â†“ Quote Now Visible to Agency                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          4. AGENCY APPROVES QUOTE (Status: APPROVED)         â”‚
â”‚  Agency â†’ Posted Quotes â†’ Approve â†’ Redirects to...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                5. APPROVED QUOTES SECTION                    â”‚
â”‚  âœ“ Pay in Full Option      âœ“ Finance Options                â”‚
â”‚  â””â”€ Full amount payment    â””â”€ EMI Calculator                â”‚
â”‚                               â””â”€ Amortization Schedule       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Step-by-Step Workflow

### **STEP 1: Agency Submits Application** ğŸ¢

**URL:** `http://localhost:3000/agency/submit`

**Actions:**
1. Sign in as agency user (agency_admin or agency_user)
2. Select industry (e.g., Construction)
3. Select subtype (e.g., Contractor)
4. Click "Continue"

**Next Page:** Dynamic form with carrier selection

**Form Fields:**
- Client Contact Information (Name, Phone, Email, EIN)
- Business Address (Street, City, State, Zip)
- **NEW: Carrier Selection Dropdown** â­
- Industry-specific form fields
- CCPA Consent (if CA operations)
- File attachments

**What Happens After Submit:**
- âœ… Submission saved to database
- âœ… Mock email logged to console for selected carrier
- âœ… RoutingLog created with status `"SENT"`
- âœ… Submission status: `"ROUTED"`
- âœ… Submission visible in Admin panel
- âœ… Redirect to agency dashboard

**Console Output Example:**
```
ğŸ“§ Mock Email to Carrier:
   To: carrier@example.com (ABC Insurance Co.)
   Subject: New Insurance Submission - John Doe Construction
   Submission ID: 507f1f77bcf86cd799439011
   Client: John Doe - john@example.com
   Industry: Construction - Contractor
âœ… Submission routed to carrier: ABC Insurance Co.
```

---

### **STEP 2: Admin Enters Quote** ğŸ‘¨â€ğŸ’¼

**URL:** `http://localhost:3000/admin/submissions`

**Actions:**
1. Sign in as system_admin
2. Click on a submission with status `"ROUTED"`
3. Click "Enter Quote" button
4. Enter quote details:
   - Select carrier (pre-populated with routed carrier)
   - Enter carrier quote amount (USD)
   - View automatic calculation:
     - Wholesale fee (based on carrier settings)
     - Broker fee (optional, agency can add later)
     - Final amount
5. Click "Create Quote"

**API Called:**
```
POST /api/admin/quotes/[submissionId]/enter
Body: {
  carrierId: "...",
  carrierQuoteUSD: 5000.00
}
```

**What Happens:**
- âœ… Quote created with status `"ENTERED"`
- âœ… Submission status changes to `"QUOTED"`
- âœ… Success message displayed
- âœ… **Auto-redirect to Post Quote page** ğŸ¯

**Quote Data Created:**
```json
{
  "status": "ENTERED",
  "carrierQuoteUSD": 5000.00,
  "wholesaleFeePercent": 15,
  "wholesaleFeeAmountUSD": 750.00,
  "brokerFeeAmountUSD": 0,
  "finalAmountUSD": 5750.00,
  "enteredByAdminId": "...",
  "enteredAt": "2025-01-15T10:30:00Z"
}
```

---

### **STEP 3: Admin Posts Quote** ğŸ“¤

**URL:** `http://localhost:3000/admin/quotes/[quoteId]/post`
*(Automatically redirected here after creating quote)*

**Page Shows:**
- âœ… Quote details summary
- âœ… Client name and carrier
- âœ… Amount breakdown
- âœ… Carrier Reference input field (optional)

**Actions:**
1. Review quote details
2. **(Optional)** Enter carrier reference/quote ID
   - Examples: `"CARR-2024-001"`, `"Q123456"`, `"ABC-INS-789"`
3. Click "Post Quote to Agency"

**API Called:**
```
POST /api/admin/quotes/[quoteId]/post
Body: {
  carrierReference: "CARR-2024-001"  // optional
}
```

**What Happens:**
- âœ… Quote status changes: `"ENTERED"` â†’ `"POSTED"`
- âœ… `postedAt` timestamp set
- âœ… Carrier reference saved (if provided)
- âœ… Quote becomes **visible in Agency dashboard**
- âœ… Mock notification to agency (console.log)
- âœ… Success message displayed
- âœ… Redirect back to admin quotes list

**Console Output:**
```
âœ… Quote posted successfully
ğŸ“§ Mock notification to agency: Quote available for approval
```

---

### **STEP 4: Agency Views Posted Quotes** ğŸ“¬

**URL:** `http://localhost:3000/agency/quotes?status=POSTED`

**From Agency Dashboard:**
- Click "Posted Quotes" card

**What Agency Sees:**
- âœ… All quotes with status `"POSTED"`
- âœ… Client information
- âœ… Carrier name
- âœ… Quote amounts (carrier quote, fees, final amount)
- âœ… Status badge: **POSTED** (purple)
- âœ… "Approve Quote" button

**Quotes NOT Visible:**
- âŒ Quotes with status `"ENTERED"` (admin hasn't posted yet)

---

### **STEP 5: Agency Approves Quote** âœ…

**Actions:**
1. Click "Approve Quote" button on a POSTED quote

**API Called:**
```
POST /api/agency/quotes/[quoteId]/approve
```

**Validation:**
- âœ… Only agency users can approve
- âœ… Quote must be in `"POSTED"` status
- âœ… Quote must belong to the agency

**What Happens:**
- âœ… Quote status changes: `"POSTED"` â†’ `"APPROVED"`
- âœ… `approvedAt` timestamp set
- âœ… `approvedByUserId` recorded
- âœ… Success message displayed
- âœ… **Auto-redirect to Approved Quotes** ğŸ¯

**Console Output:**
```
âœ… Quote [quoteId] approved by agency user [userId]
ğŸ“§ Mock notification: Agency approved quote for John Doe Construction
```

---

### **STEP 6: Approved Quotes - Payment Options** ğŸ’°

**URL:** `http://localhost:3000/agency/quotes?status=APPROVED`

**From Agency Dashboard:**
- Click "Approved Quotes" card

**What Agency Sees:**
Two payment option cards side-by-side:

#### **Option A: Pay in Full** ğŸ’µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pay in Full                â”‚
â”‚ $5,750.00                  â”‚
â”‚ One-time payment           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**
- Shows final total amount
- One-click payment (Part 8: Payment integration)

#### **Option B: Finance Options** ğŸ“Š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Finance Options            â”‚
â”‚ View financing plans       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Click to Expand Finance Details:**

**Finance Calculator:**
- **Down Payment Slider:** 0% to 100%
- **Tenure Dropdown:** 6, 12, 18, 24, 36, 48, 60 months
- **Annual Interest Input:** Custom rate (e.g., 8.5%)

**Real-time Calculation Shows:**
- Down payment amount
- Principal amount (financed amount)
- Monthly EMI (installment)
- Total payable amount
- Total interest

**Example Calculation:**
```
Total Amount: $5,750.00
Down Payment (20%): $1,150.00
Principal: $4,600.00
Tenure: 12 months
Interest: 8.5% p.a.

Monthly EMI: $397.45
Total Payable: $5,919.40
Total Interest: $169.40
```

**Amortization Schedule (First 12 Months):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Month â”‚ EMI        â”‚ Principalâ”‚ Interest â”‚ Balance  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   1   â”‚ $397.45    â”‚ $364.78  â”‚ $32.67   â”‚ $4,235.22â”‚
â”‚   2   â”‚ $397.45    â”‚ $367.35  â”‚ $30.10   â”‚ $3,867.87â”‚
â”‚  ...  â”‚    ...     â”‚   ...    â”‚   ...    â”‚   ...    â”‚
â”‚  12   â”‚ $397.45    â”‚ $394.64  â”‚  $2.81   â”‚   $0.00  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Actions:**
- Adjust sliders/inputs â†’ Auto-recalculates
- Click "Calculate EMI" â†’ Refresh calculation
- Click "Save Finance Plan" â†’ Store plan to quote

---

## ğŸ” Role-Based Access Control (RBAC)

### **System Admin**
âœ… Can access:
- `/admin/submissions` - View all submissions
- `/admin/quotes` - View all quotes
- `/admin/quotes/[id]/enter` - Enter new quotes
- `/admin/quotes/[id]/post` - Post quotes to agencies

âŒ Cannot access:
- Agency-specific routes

### **Agency Admin / Agency User**
âœ… Can access:
- `/agency/submit` - Create new submissions
- `/agency/submissions` - View own submissions
- `/agency/quotes?status=POSTED` - View posted quotes
- `/agency/quotes?status=APPROVED` - View approved quotes
- `/agency/quotes/[id]/approve` - Approve posted quotes

âŒ Cannot access:
- Admin routes
- Quotes with status `"ENTERED"` (not posted yet)
- Other agencies' data

---

## ğŸ“Š Quote Status Lifecycle

```
ENTERED
  â†“ (Admin posts quote)
POSTED
  â†“ (Agency approves quote)
APPROVED
  â†“ (Agency selects payment/finance - Part 8)
BIND_REQUESTED
  â†“ (Admin binds policy - Part 10)
BOUND
```

### **Status Details:**

| Status | Visible To | Actions Available | Next Step |
|--------|-----------|-------------------|-----------|
| `ENTERED` | Admin only | Post quote | Admin posts |
| `POSTED` | Admin + Agency | Approve quote | Agency approves |
| `APPROVED` | Admin + Agency | Pay/Finance | Agency pays (Part 8) |
| `BIND_REQUESTED` | Admin + Agency | Bind policy | Admin binds (Part 10) |
| `BOUND` | Admin + Agency | View policy | Complete |

---

## ğŸ¨ UI/UX Flow Summary

### **Admin Journey:**
```
1. Login â†’ Admin Dashboard
2. Click "Submissions"
3. Click submission â†’ View details
4. Click "Enter Quote"
5. Fill quote form â†’ Submit
   â†“ Auto-redirect
6. Post Quote page â†’ Add reference â†’ Post
   â†“ Auto-redirect
7. Back to Quotes list â†’ See quote as POSTED
```

### **Agency Journey:**
```
1. Login â†’ Agency Dashboard
2. Click "New Submission"
3. Select industry/subtype
4. Fill form + Select Carrier â†’ Submit
   â†“ Return to dashboard
5. Wait for admin to post quote
6. Click "Posted Quotes"
7. See quote â†’ Click "Approve Quote"
   â†“ Auto-redirect to Approved Quotes
8. View payment options:
   - Pay in Full
   - Finance Options (EMI calculator)
```

---

## ğŸ§ª Testing Checklist

### **End-to-End Test:**

- [ ] **Agency Submission**
  - [ ] Can select carrier from dropdown
  - [ ] Form validates all required fields
  - [ ] File upload works
  - [ ] Mock email appears in console
  - [ ] Submission appears in admin panel

- [ ] **Admin Quote Entry**
  - [ ] Can access submission details
  - [ ] Carrier selection works
  - [ ] Amount calculations correct
  - [ ] Quote created with status `ENTERED`
  - [ ] Redirects to post quote page

- [ ] **Admin Post Quote**
  - [ ] Post page shows correct quote details
  - [ ] Can add carrier reference
  - [ ] Post button works
  - [ ] Status changes to `POSTED`
  - [ ] Redirects to quotes list

- [ ] **Agency Posted Quotes**
  - [ ] Posted quote appears in agency dashboard
  - [ ] `ENTERED` quotes NOT visible
  - [ ] Approve button present
  - [ ] Quote details accurate

- [ ] **Agency Approve Quote**
  - [ ] Approve button works
  - [ ] Status changes to `APPROVED`
  - [ ] Redirects to approved quotes section

- [ ] **Finance Options**
  - [ ] Both payment options visible
  - [ ] Finance calculator works
  - [ ] EMI calculations accurate
  - [ ] Amortization schedule displays correctly
  - [ ] Can adjust all parameters

---

## ğŸš€ Quick Start Commands

```bash
# 1. Start development server
npm run dev

# 2. Open browser
http://localhost:3000

# 3. Sign in as Admin
Email: admin@sterlingportal.com
Password: [your admin password]

# 4. Sign in as Agency
Email: agency@example.com
Password: [your agency password]
```

---

## ğŸ“ API Endpoints Reference

| Method | Endpoint | Purpose | Auth Required |
|--------|----------|---------|---------------|
| POST | `/api/submissions` | Create submission | agency_* |
| GET | `/api/admin/submissions` | List all submissions | system_admin |
| GET | `/api/admin/submissions/[id]` | Get submission details | system_admin |
| POST | `/api/admin/quotes/[id]/enter` | Enter quote (id=submissionId) | system_admin |
| GET | `/api/admin/quotes/[id]` | Get quote details (id=quoteId) | system_admin |
| POST | `/api/admin/quotes/[id]/post` | Post quote (id=quoteId) | system_admin |
| GET | `/api/admin/quotes` | List all quotes | system_admin |
| GET | `/api/agency/quotes` | List agency quotes | agency_* |
| POST | `/api/agency/quotes/[id]/approve` | Approve quote | agency_* |
| POST | `/api/finance/calculate` | Calculate EMI | agency_* |
| GET | `/api/finance/[quoteId]` | Get finance plan | agency_* |
| POST | `/api/finance/[quoteId]` | Save finance plan | agency_* |

---

## ğŸ¯ Next Steps (Future Parts)

- **Part 8:** Payment Integration (Stripe/PayPal)
- **Part 9:** Document Management & E-Signatures
- **Part 10:** Bind Requests & Policy Management
- **Part 11:** Advanced Admin Dashboard & Analytics
- **Part 12:** Testing Suite & Docker Deployment

---

## ğŸ’¡ Tips & Best Practices

1. **Always check the terminal console** for mock email logs
2. **Use carrier references** to track quotes from carriers
3. **Test with different roles** to verify RBAC
4. **Clear browser cache** if you see stale data
5. **Restart dev server** after major model changes

---

## ğŸ› Troubleshooting

### **Quote not visible in agency dashboard?**
- Check quote status (must be `POSTED`, not `ENTERED`)
- Verify admin posted the quote
- Refresh the page

### **Cannot approve quote?**
- Ensure quote is `POSTED` status
- Verify you're logged in as agency user
- Check quote belongs to your agency

### **Finance calculator not showing?**
- Ensure quote is `APPROVED` status
- Check browser console for errors
- Verify finance APIs are working

### **Redirect not working after approve?**
- Check browser console for errors
- Verify API response is successful
- Clear browser cache and retry

---

**All systems ready!** ğŸš€

Start testing from Step 1 and follow the complete workflow.



